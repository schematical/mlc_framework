<?php
abstract class <%= strtoupper(MLC_APPLICATION_PREFIX); %>JsonSearchDriverHandeler{

    public static function GetExtension(){
        if(array_key_exists('mjax-route-ext', $_GET)){
            return $_GET['mjax-route-ext'];
        }
        return pathinfo($_SERVER['REQUEST_URI'], PATHINFO_EXTENSION);
    }
    public static function Run(){
         if(array_key_exists('search', $_POST)){
            $strSearch = $_POST['search'];
         }else{
            $strSearch = '';
         }

         $arrParts = explode('_', self::GetExtension());
         $strExtension = $arrParts[0];
         if(count($arrParts) == 2){
            $strField = $arrParts[1];
         }else{
            $strField = null;
         }
         $objSearchDriver = MLCApplication::$objRewriteHandeler->EntityManager;
         if(is_null($objSearchDriver)){
            $objSearchDriver = new <%= strtoupper(MLC_APPLICATION_PREFIX); %>EntityManager();
         }
        $objSearchDriver->Populate();
         switch($strExtension){
           <% foreach ($data as $arrTable){ %>
                case('<%= MLCTemplateDriver::Capatilize($arrTable['name']); %>'):
                case('<%= strtolower($arrTable['name']); %>'):
                    $arrEntities = $objSearchDriver->Search<%= MLCTemplateDriver::Capatilize($arrTable['name']); %>($strSearch, $strField);
                    self::RenderJsonResponse($arrEntities, $strField);
                break;
           <% } %>
           default:
           die(json_encode(array('error'=>'Not a valid searchable entity: ' . $strExtension)));
         }
    }
    public static function RenderJsonResponse($arrEntities, $strField = null){
        $arrData = array();

        foreach($arrEntities as $objEntity){
            if(is_null($strField)){
                $strText = $objEntity->__toString();
            }else{
                $strText = $objEntity->__get($strField);
            }
            $arrData[] = array(
                'text' => $strText,
                'value' => get_class($objEntity) . '_' . $objEntity->GetId()
            );
        }
        die(json_encode($arrData));
    }
}
<%= strtoupper(MLC_APPLICATION_PREFIX); %>JsonSearchDriverHandeler::Run();